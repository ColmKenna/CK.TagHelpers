@using CK.Taghelpers.SampleUsage.Models
@{
    ViewData["Title"] = "Dynamic Editor";
}

@{
    // Sample enums for multi-select demonstration
    var dayOfWeekList = new List<DayOfWeek> { DayOfWeek.Monday, DayOfWeek.Wednesday, DayOfWeek.Friday };

    // Sample models to edit
    var userModel = new { FirstName = "John", LastName = "Doe", IsActive = true, BirthDate = DateTime.Now.AddYears(-25) };
    var productModel = new { Name = "Widget Pro", Price = 29.99m, InStock = true, Category = "Electronics" };
    var settingsModel = new { Theme = "Dark", NotificationsEnabled = true, Language = "English", MaxItems = 50 };
    var scheduleModel = new { TaskName = "Weekly Report", Priority = 3, WorkDays = dayOfWeekList };
    
    // Sample model for validation demonstration - uses built-in ASP.NET Core validation attributes
    var registrationModel = new RegistrationViewModel
    {
        Username = "",
        Email = "",
        Age = 0,
        Password = ""
    };
}

<div class="container py-4">
    <h1>Dynamic Editor ViewComponent</h1>
    <p class="lead">The Dynamic Editor is a ViewComponent that automatically generates a dialog-based form for any model you pass to it.</p>
    
    <hr />

    <section class="mb-5">
        <h2>Features</h2>
        <ul>
            <li>Automatically reflects model properties to generate form fields</li>
            <li>Supports basic types: string, numbers, booleans, DateTime, enums</li>
            <li>Supports multi-select dropdowns for IEnumerable/List of enums</li>
            <li>Dispatches custom events on confirm/cancel</li>
            <li>Each instance gets a unique dialog ID to prevent conflicts</li>
            <li><strong>Built-in validation support</strong> - uses ASP.NET Core validation attributes</li>
        </ul>
    </section>

    <section class="mb-5">
        <h2>Example 1: User Editor</h2>
        <div class="card">
            <div class="card-body">
                <p>Click the button to edit user information:</p>
                <vc:dynamic-editor model="@userModel" event-name="User"></vc:dynamic-editor>
                <button class="btn btn-primary" onclick="document.getElementById('user-dialog').showModal()">Edit User</button>
                <div id="user-output" class="mt-3 text-muted"></div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2>Example 2: Product Editor</h2>
        <div class="card">
            <div class="card-body">
                <p>Edit product details:</p>
                <vc:dynamic-editor model="@productModel" event-name="Product"></vc:dynamic-editor>
                <button class="btn btn-success" onclick="document.getElementById('product-dialog').showModal()">Edit Product</button>
                <div id="product-output" class="mt-3 text-muted"></div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2>Example 3: Settings Editor</h2>
        <div class="card">
            <div class="card-body">
                <p>Modify application settings:</p>
                <vc:dynamic-editor model="@settingsModel" event-name="Settings"></vc:dynamic-editor>
                <button class="btn btn-secondary" onclick="document.getElementById('settings-dialog').showModal()">Edit Settings</button>
                <div id="settings-output" class="mt-3 text-muted"></div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2>Example 4: Multi-Select with Enum Collection</h2>
        <div class="card">
            <div class="card-body">
                <p>Edit schedule with multi-select dropdown for work days:</p>
                <vc:dynamic-editor model="@scheduleModel" event-name="Schedule"></vc:dynamic-editor>
                <button class="btn btn-info" onclick="document.getElementById('schedule-dialog').showModal()">Edit Schedule</button>
                <div id="schedule-output" class="mt-3 text-muted"></div>
                <div class="alert alert-info mt-3">
                    <strong>Note:</strong> The WorkDays property is a List&lt;DayOfWeek&gt; and renders as a multi-select dropdown.
                    Hold Ctrl (or Cmd on Mac) to select multiple days.
                </div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2>Example 5: Modal with Built-in Validation</h2>
        <div class="card">
            <div class="card-body">
                <p>This example demonstrates how to use ASP.NET Core validation attributes with the DynamicEditor:</p>
                <vc:dynamic-editor model="@registrationModel" event-name="Registration"></vc:dynamic-editor>
                <button class="btn btn-warning" onclick="document.getElementById('registration-dialog').showModal()">Register User</button>
                <div id="registration-output" class="mt-3 text-muted"></div>
                <div class="alert alert-warning mt-3">
                    <strong>Validation Attributes Used:</strong>
                    <ul class="mb-0 mt-2">
                        <li><code>[Required]</code> - All fields are required</li>
                        <li><code>[MinLength(3)]</code> - Username must be at least 3 characters</li>
                        <li><code>[MaxLength(50)]</code> - Username cannot exceed 50 characters</li>
                        <li><code>[EmailAddress]</code> - Email must be a valid email format</li>
                        <li><code>[Range(18, 120)]</code> - Age must be between 18 and 120</li>
                        <li><code>[DataType(DataType.Password)]</code> - Password is masked</li>
                    </ul>
                </div>
                <div class="alert alert-secondary mt-2">
                    <strong>Model Definition:</strong>
                    <pre class="mb-0 mt-2"><code>public class RegistrationViewModel
{
    [Required]
    [MinLength(3)]
    [MaxLength(50)]
    public string Username { get; set; }

    [Required]
    [EmailAddress]
    public string Email { get; set; }

    [Required]
    [Range(18, 120)]
    public int Age { get; set; }

    [Required]
    [MinLength(6)]
    [DataType(DataType.Password)]
    public string Password { get; set; }
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2>Usage</h2>
        <pre><code class="language-html">@@{
    var userModel = new { FirstName = "John", LastName = "Doe", IsActive = true };
}

&lt;vc:dynamic-editor model="@@userModel" event-name="User"&gt;&lt;/vc:dynamic-editor&gt;

&lt;button onclick="document.querySelector('dialog').showModal()"&gt;Edit User&lt;/button&gt;

&lt;script&gt;
    document.addEventListener('User-update', function (e) {
        console.log('Update confirmed!', e.detail);
    });

    document.addEventListener('User-cancel', function (e) {
        console.log('Edit cancelled');
    });
&lt;/script&gt;</code></pre>
    </section>
</div>

<style>
    .dynamic-editor-dialog {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 0;
        max-width: 500px;
        width: 90%;
    }

    .dynamic-editor-dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
    }

    .dynamic-editor-dialog form {
        padding: 1.5rem;
    }

    .dynamic-editor-dialog h3 {
        margin: 0 0 1.5rem 0;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .dynamic-editor-dialog .form-group {
        margin-bottom: 1rem;
    }

    .dynamic-editor-dialog label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .dynamic-editor-dialog .required-indicator {
        color: #dc3545;
        margin-left: 0.25rem;
    }

    .dynamic-editor-dialog input,
    .dynamic-editor-dialog select,
    .dynamic-editor-dialog textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
    }

    .dynamic-editor-dialog input[type="checkbox"] {
        width: auto;
    }

    .dynamic-editor-dialog select[multiple] {
        height: 150px;
    }

    .dynamic-editor-dialog .actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }

    .dynamic-editor-dialog button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }

    .dynamic-editor-dialog .actions button:first-child {
        background: #6c757d;
        color: white;
    }

    .dynamic-editor-dialog .actions button:last-child {
        background: #0d6efd;
        color: white;
    }

    /* Validation styles */
    .dynamic-editor-dialog .validation-summary {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        color: #721c24;
    }

    .dynamic-editor-dialog .validation-summary ul {
        margin: 0;
        padding-left: 1.25rem;
    }

    .dynamic-editor-dialog .input-validation-error {
        border-color: #dc3545 !important;
    }

    .dynamic-editor-dialog .input-validation-error:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .dynamic-editor-dialog .field-validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        display: block;
        margin-top: 0.25rem;
    }
</style>

<script>
    // Find all dialogs dynamically (since they have unique IDs)
    document.addEventListener('DOMContentLoaded', function() {
        const dialogs = document.querySelectorAll('dialog.dynamic-editor-dialog');
        const dialogIdMap = {
            User: 'user-dialog',
            Product: 'product-dialog',
            Settings: 'settings-dialog',
            Schedule: 'schedule-dialog',
            Registration: 'registration-dialog'
        };

        // Map dialogs to readable IDs using data-event-name
        dialogs.forEach(dialog => {
            const eventName = (dialog.dataset.eventName || '').trim();
            const dialogId = dialogIdMap[eventName];
            if (dialogId) {
                dialog.id = dialogId;
            }
        });
    });

    // Event listeners for each editor
    document.addEventListener('User-update', function (e) {
        document.getElementById('user-output').innerHTML = 
            '<strong>Updated:</strong> ' + JSON.stringify(e.detail, null, 2);
    });

    document.addEventListener('User-cancel', function (e) {
        const output = '<em>User edit cancelled</em><br>' +
            '<strong>Original Values:</strong> <pre>' + JSON.stringify(e.detail.originalValues, null, 2) + '</pre>' +
            '<strong>Canceled Values:</strong> <pre>' + JSON.stringify(e.detail.canceledValues, null, 2) + '</pre>';
        document.getElementById('user-output').innerHTML = output;
    });

    document.addEventListener('Product-update', function (e) {
        document.getElementById('product-output').innerHTML = 
            '<strong>Updated:</strong> ' + JSON.stringify(e.detail, null, 2);
    });

    document.addEventListener('Product-cancel', function (e) {
        const output = '<em>Product edit cancelled</em><br>' +
            '<strong>Original Values:</strong> <pre>' + JSON.stringify(e.detail.originalValues, null, 2) + '</pre>' +
            '<strong>Canceled Values:</strong> <pre>' + JSON.stringify(e.detail.canceledValues, null, 2) + '</pre>';
        document.getElementById('product-output').innerHTML = output;
    });

    document.addEventListener('Settings-update', function (e) {
        document.getElementById('settings-output').innerHTML =
            '<strong>Updated:</strong> ' + JSON.stringify(e.detail, null, 2);
    });

    document.addEventListener('Settings-cancel', function (e) {
        const output = '<em>Settings edit cancelled</em><br>' +
            '<strong>Original Values:</strong> <pre>' + JSON.stringify(e.detail.originalValues, null, 2) + '</pre>' +
            '<strong>Canceled Values:</strong> <pre>' + JSON.stringify(e.detail.canceledValues, null, 2) + '</pre>';
        document.getElementById('settings-output').innerHTML = output;
    });

    document.addEventListener('Schedule-update', function (e) {
        document.getElementById('schedule-output').innerHTML =
            '<strong>Updated:</strong> <pre>' + JSON.stringify(e.detail, null, 2) + '</pre>';
    });

    document.addEventListener('Schedule-cancel', function (e) {
        const output = '<em>Schedule edit cancelled</em><br>' +
            '<strong>Original Values:</strong> <pre>' + JSON.stringify(e.detail.originalValues, null, 2) + '</pre>' +
            '<strong>Canceled Values:</strong> <pre>' + JSON.stringify(e.detail.canceledValues, null, 2) + '</pre>';
        document.getElementById('schedule-output').innerHTML = output;
    });

    document.addEventListener('Registration-update', function (e) {
        document.getElementById('registration-output').innerHTML =
            '<div class="alert alert-success"><strong>Registration Successful!</strong></div>' +
            '<strong>Submitted Data:</strong> <pre>' + JSON.stringify(e.detail, null, 2) + '</pre>';
    });

    document.addEventListener('Registration-cancel', function (e) {
        const output = '<em>Registration cancelled</em><br>' +
            '<strong>Original Values:</strong> <pre>' + JSON.stringify(e.detail.originalValues, null, 2) + '</pre>' +
            '<strong>Canceled Values:</strong> <pre>' + JSON.stringify(e.detail.canceledValues, null, 2) + '</pre>';
        document.getElementById('registration-output').innerHTML = output;
    });
</script>
